"""
Search tab - Tab t√¨m ki·∫øm c∆° b·∫£n
"""

from PyQt5.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QFormLayout,
    QLineEdit, QSpinBox, QComboBox, QPushButton, QTextEdit,
    QLabel, QGroupBox, QScrollArea, QFrame
)
from PyQt5.QtCore import Qt, pyqtSignal
from PyQt5.QtGui import QFont

from ..utils.constants import SUPPORTED_LANGUAGES
from ..utils.logger import get_logger

logger = get_logger(__name__)


class SearchTab(QWidget):
    """Tab t√¨m ki·∫øm c∆° b·∫£n"""
    
    start_scraping_signal = pyqtSignal()
    
    def __init__(self):
        super().__init__()
        self.init_ui()
        self.setup_connections()
    
    def init_ui(self):
        """Kh·ªüi t·∫°o giao di·ªán"""
        layout = QVBoxLayout(self)
        layout.setSpacing(20)
        layout.setContentsMargins(20, 20, 20, 20)
        
        # Title
        title_label = QLabel("üîç T√¨m ki·∫øm c∆° b·∫£n")
        title_font = QFont()
        title_font.setPointSize(16)
        title_font.setBold(True)
        title_label.setFont(title_font)
        layout.addWidget(title_label)
        
        # Description
        desc_label = QLabel(
            "Nh·∫≠p t·ª´ kh√≥a v√† ƒë·ªãa ƒëi·ªÉm ƒë·ªÉ b·∫Øt ƒë·∫ßu thu th·∫≠p d·ªØ li·ªáu t·ª´ Google Maps. "
            "B·∫°n c√≥ th·ªÉ t√¨m ki·∫øm nhi·ªÅu t·ª´ kh√≥a c√πng l√∫c ƒë·ªÉ c√≥ k·∫øt qu·∫£ ƒëa d·∫°ng h∆°n."
        )
        desc_label.setWordWrap(True)
        desc_label.setStyleSheet("color: #666; margin-bottom: 10px;")
        layout.addWidget(desc_label)
        
        # Main form
        form_group = QGroupBox("Th√¥ng tin t√¨m ki·∫øm")
        form_layout = QFormLayout(form_group)
        form_layout.setSpacing(15)
        
        # Search terms
        search_terms_group = QGroupBox("T·ª´ kh√≥a t√¨m ki·∫øm")
        search_terms_layout = QVBoxLayout(search_terms_group)
        
        self.search_terms_text = QTextEdit()
        self.search_terms_text.setPlaceholderText(
            "Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm, m·ªói t·ª´ kh√≥a tr√™n m·ªôt d√≤ng:\n"
            "V√≠ d·ª•:\n"
            "restaurant\n"
            "hotel\n"
            "coffee shop\n"
            "pharmacy"
        )
        self.search_terms_text.setMaximumHeight(120)
        search_terms_layout.addWidget(self.search_terms_text)
        
        # Add/Remove buttons
        buttons_layout = QHBoxLayout()
        self.add_term_btn = QPushButton("‚ûï Th√™m t·ª´ kh√≥a")
        self.remove_term_btn = QPushButton("‚ûñ X√≥a t·ª´ kh√≥a")
        self.clear_terms_btn = QPushButton("üóëÔ∏è X√≥a t·∫•t c·∫£")
        
        buttons_layout.addWidget(self.add_term_btn)
        buttons_layout.addWidget(self.remove_term_btn)
        buttons_layout.addWidget(self.clear_terms_btn)
        buttons_layout.addStretch()
        
        search_terms_layout.addLayout(buttons_layout)
        form_layout.addRow(search_terms_group)
        
        # Location
        location_group = QGroupBox("ƒê·ªãa ƒëi·ªÉm")
        location_layout = QVBoxLayout(location_group)
        
        self.location_input = QLineEdit()
        self.location_input.setPlaceholderText("V√≠ d·ª•: Hanoi, Vietnam ho·∫∑c New York, USA")
        location_layout.addWidget(self.location_input)
        
        # Location buttons
        location_buttons_layout = QHBoxLayout()
        self.validate_location_btn = QPushButton("üîç Ki·ªÉm tra ƒë·ªãa ƒëi·ªÉm")
        self.current_location_btn = QPushButton("üìç V·ªã tr√≠ hi·ªán t·∫°i")
        
        location_buttons_layout.addWidget(self.validate_location_btn)
        location_buttons_layout.addWidget(self.current_location_btn)
        location_buttons_layout.addStretch()
        
        location_layout.addLayout(location_buttons_layout)
        form_layout.addRow(location_group)
        
        # Max places
        self.max_places_spin = QSpinBox()
        self.max_places_spin.setRange(0, 9999)
        self.max_places_spin.setValue(50)
        self.max_places_spin.setSpecialValueText("T·∫•t c·∫£")
        self.max_places_spin.setToolTip("S·ªë l∆∞·ª£ng ƒë·ªãa ƒëi·ªÉm t·ªëi ƒëa ƒë·ªÉ thu th·∫≠p. ƒê·ªÉ 0 ƒë·ªÉ thu th·∫≠p t·∫•t c·∫£.")
        form_layout.addRow("S·ªë l∆∞·ª£ng ƒë·ªãa ƒëi·ªÉm:", self.max_places_spin)
        
        # Language
        self.language_combo = QComboBox()
        for code, name in SUPPORTED_LANGUAGES.items():
            self.language_combo.addItem(f"{name} ({code})", code)
        
        # Set Vietnamese as default
        vietnamese_index = self.language_combo.findData("vi")
        if vietnamese_index >= 0:
            self.language_combo.setCurrentIndex(vietnamese_index)
        else:
            # Fallback to English
            english_index = self.language_combo.findData("en")
            if english_index >= 0:
                self.language_combo.setCurrentIndex(english_index)
        
        form_layout.addRow("Ng√¥n ng·ªØ k·∫øt qu·∫£:", self.language_combo)
        
        layout.addWidget(form_group)
        
        # Action buttons
        buttons_group = QGroupBox("Thao t√°c")
        buttons_layout = QHBoxLayout(buttons_group)
        
        self.start_btn = QPushButton("‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu thu th·∫≠p")
        self.start_btn.setStyleSheet("""
            QPushButton {
                background-color: #4CAF50;
                color: white;
                border: none;
                padding: 12px 24px;
                font-size: 14px;
                font-weight: bold;
                border-radius: 6px;
            }
            QPushButton:hover {
                background-color: #45a049;
            }
            QPushButton:pressed {
                background-color: #3d8b40;
            }
        """)
        
        self.save_config_btn = QPushButton("üíæ L∆∞u c·∫•u h√¨nh")
        self.load_config_btn = QPushButton("üìÅ T·∫£i c·∫•u h√¨nh")
        
        buttons_layout.addWidget(self.start_btn)
        buttons_layout.addStretch()
        buttons_layout.addWidget(self.save_config_btn)
        buttons_layout.addWidget(self.load_config_btn)
        
        layout.addWidget(buttons_group)
        
        # Add stretch to push everything to top
        layout.addStretch()
    
    def setup_connections(self):
        """Setup signal connections"""
        self.start_btn.clicked.connect(self.start_scraping)
        self.add_term_btn.clicked.connect(self.add_search_term)
        self.remove_term_btn.clicked.connect(self.remove_search_term)
        self.clear_terms_btn.clicked.connect(self.clear_search_terms)
        self.validate_location_btn.clicked.connect(self.validate_location)
        self.current_location_btn.clicked.connect(self.use_current_location)
        self.save_config_btn.clicked.connect(self.save_configuration)
        self.load_config_btn.clicked.connect(self.load_configuration)
    
    def start_scraping(self):
        """B·∫Øt ƒë·∫ßu thu th·∫≠p d·ªØ li·ªáu"""
        # Validate input
        search_terms = self.get_search_terms()
        if not search_terms:
            from PyQt5.QtWidgets import QMessageBox
            QMessageBox.warning(
                self,
                "Thi·∫øu th√¥ng tin",
                "Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt t·ª´ kh√≥a t√¨m ki·∫øm."
            )
            return
        
        location = self.location_input.text().strip()
        if not location:
            from PyQt5.QtWidgets import QMessageBox
            QMessageBox.warning(
                self,
                "Thi·∫øu th√¥ng tin",
                "Vui l√≤ng nh·∫≠p ƒë·ªãa ƒëi·ªÉm t√¨m ki·∫øm."
            )
            return
        
        # Emit signal
        self.start_scraping_signal.emit()
        logger.info(f"Starting scraping for terms: {search_terms}, location: {location}")
    
    def add_search_term(self):
        """Th√™m t·ª´ kh√≥a t√¨m ki·∫øm"""
        from PyQt5.QtWidgets import QInputDialog
        
        term, ok = QInputDialog.getText(
            self,
            "Th√™m t·ª´ kh√≥a",
            "Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm:"
        )
        
        if ok and term.strip():
            current_text = self.search_terms_text.toPlainText()
            if current_text and not current_text.endswith('\n'):
                current_text += '\n'
            current_text += term.strip()
            self.search_terms_text.setPlainText(current_text)
    
    def remove_search_term(self):
        """X√≥a t·ª´ kh√≥a t√¨m ki·∫øm"""
        from PyQt5.QtWidgets import QInputDialog
        
        terms = self.get_search_terms()
        if not terms:
            return
        
        term, ok = QInputDialog.getItem(
            self,
            "X√≥a t·ª´ kh√≥a",
            "Ch·ªçn t·ª´ kh√≥a c·∫ßn x√≥a:",
            terms,
            0,
            False
        )
        
        if ok and term:
            terms.remove(term)
            self.search_terms_text.setPlainText('\n'.join(terms))
    
    def clear_search_terms(self):
        """X√≥a t·∫•t c·∫£ t·ª´ kh√≥a"""
        from PyQt5.QtWidgets import QMessageBox
        
        reply = QMessageBox.question(
            self,
            "X√°c nh·∫≠n",
            "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ t·ª´ kh√≥a t√¨m ki·∫øm?",
            QMessageBox.Yes | QMessageBox.No,
            QMessageBox.No
        )
        
        if reply == QMessageBox.Yes:
            self.search_terms_text.clear()
    
    def validate_location(self):
        """Ki·ªÉm tra ƒë·ªãa ƒëi·ªÉm"""
        location = self.location_input.text().strip()
        if not location:
            from PyQt5.QtWidgets import QMessageBox
            QMessageBox.warning(
                self,
                "Thi·∫øu th√¥ng tin",
                "Vui l√≤ng nh·∫≠p ƒë·ªãa ƒëi·ªÉm tr∆∞·ªõc khi ki·ªÉm tra."
            )
            return
        
        # TODO: Implement location validation with OpenStreetMap API
        from PyQt5.QtWidgets import QMessageBox
        QMessageBox.information(
            self,
            "Ki·ªÉm tra ƒë·ªãa ƒëi·ªÉm",
            f"T√≠nh nƒÉng ki·ªÉm tra ƒë·ªãa ƒëi·ªÉm '{location}' s·∫Ω ƒë∆∞·ª£c th√™m trong phi√™n b·∫£n ti·∫øp theo."
        )
    
    def use_current_location(self):
        """S·ª≠ d·ª•ng v·ªã tr√≠ hi·ªán t·∫°i"""
        # TODO: Implement geolocation
        from PyQt5.QtWidgets import QMessageBox
        QMessageBox.information(
            self,
            "V·ªã tr√≠ hi·ªán t·∫°i",
            "T√≠nh nƒÉng s·ª≠ d·ª•ng v·ªã tr√≠ hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c th√™m trong phi√™n b·∫£n ti·∫øp theo."
        )
    
    def save_configuration(self):
        """L∆∞u c·∫•u h√¨nh"""
        # TODO: Implement save configuration
        from PyQt5.QtWidgets import QMessageBox
        QMessageBox.information(
            self,
            "L∆∞u c·∫•u h√¨nh",
            "T√≠nh nƒÉng l∆∞u c·∫•u h√¨nh s·∫Ω ƒë∆∞·ª£c th√™m trong phi√™n b·∫£n ti·∫øp theo."
        )
    
    def load_configuration(self):
        """T·∫£i c·∫•u h√¨nh"""
        # TODO: Implement load configuration
        from PyQt5.QtWidgets import QMessageBox
        QMessageBox.information(
            self,
            "T·∫£i c·∫•u h√¨nh",
            "T√≠nh nƒÉng t·∫£i c·∫•u h√¨nh s·∫Ω ƒë∆∞·ª£c th√™m trong phi√™n b·∫£n ti·∫øp theo."
        )
    
    def get_search_terms(self):
        """L·∫•y danh s√°ch t·ª´ kh√≥a t√¨m ki·∫øm"""
        text = self.search_terms_text.toPlainText().strip()
        if not text:
            return []
        
        terms = [term.strip() for term in text.split('\n') if term.strip()]
        return terms
    
    def get_search_data(self):
        """L·∫•y d·ªØ li·ªáu t√¨m ki·∫øm"""
        return {
            "search_strings": self.get_search_terms(),
            "location": self.location_input.text().strip(),
            "max_places": self.max_places_spin.value() if self.max_places_spin.value() > 0 else None,
            "language": self.language_combo.currentData()
        }
    
    def reset_form(self):
        """Reset form v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu"""
        self.search_terms_text.clear()
        self.location_input.clear()
        self.max_places_spin.setValue(50)
        
        # Reset language to Vietnamese
        vietnamese_index = self.language_combo.findData("vi")
        if vietnamese_index >= 0:
            self.language_combo.setCurrentIndex(vietnamese_index)
